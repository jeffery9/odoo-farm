<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Land Parcel GIS Form View -->
    <record id="view_location_form_inherit_farm_gis" model="ir.ui.view">
        <field name="name">stock.location.form.farm.gis</field>
        <field name="model">stock.location</field>
        <field name="inherit_id" ref="stock.view_location_form"/>
        <field name="arch" type="xml">
            <xpath expr="//group[@name='main_group']" position="after">
                <group string="Agricultural &amp; GIS Info" invisible="not is_land_parcel">
                    <group>
                        <field name="is_land_parcel"/>
                        <field name="land_nature"/>
                        <field name="land_area"/>
                        <field name="soil_type"/>
                    </group>
                    <group string="Geographic Coordinates">
                        <field name="gps_lat"/>
                        <field name="gps_lng"/>
                        <field name="gis_map_url" widget="url" text="View on Map" invisible="not gis_map_url"/>
                    </group>
                </group>
                <group string="Terroir Profiling (风土数字化)" invisible="not is_land_parcel">
                    <group>
                        <field name="slope"/>
                        <field name="aspect"/>
                        <field name="water_source"/>
                    </group>
                    <group>
                        <field name="soil_mineral_composition"/>
                        <field name="micro_climate_notes"/>
                    </group>
                </group>
                <group string="Vertical Farming / High-Density" invisible="usage != 'internal'">
                    <group>
                        <field name="is_vertical_location"/>
                        <field name="shelf_id" invisible="not is_vertical_location"/>
                    </group>
                    <group invisible="not is_vertical_location">
                        <field name="shelf_level"/>
                        <field name="shelf_slot"/>
                    </group>
                </group>
                <group string="Latest Soil Health" invisible="not is_land_parcel">
                    <group>
                        <field name="latest_ph"/>
                        <field name="latest_organic_matter"/>
                    </group>
                </group>
                <notebook invisible="not is_land_parcel">
                    <page string="Soil Analysis History" name="soil_history">
                        <field name="soil_analysis_ids" readonly="1">
                            <list>
                                <field name="analysis_date"/>
                                <field name="ph_level"/>
                                <field name="organic_matter"/>
                                <field name="nitrogen_content"/>
                                <field name="state" widget="badge"/>
                            </list>
                        </field>
                    </page>
                    <page string="Nutrient Balance" name="nutrient_balance">
                        <group>
                            <group string="Optimal Targets (per mu)">
                                <field name="target_n_per_mu"/>
                                <field name="target_p_per_mu"/>
                                <field name="target_k_per_mu"/>
                            </group>
                            <group string="Current Balance Status (Total)">
                                <field name="n_balance_status" decoration-danger="n_balance_status &lt; 0" decoration-success="n_balance_status &gt; 0"/>
                                <field name="p_balance_status" decoration-danger="p_balance_status &lt; 0" decoration-success="p_balance_status &gt; 0"/>
                                <field name="k_balance_status" decoration-danger="k_balance_status &lt; 0" decoration-success="k_balance_status &gt; 0"/>
                            </group>
                        </group>
                        <group string="Cumulative Actual Inputs">
                            <field name="total_n_input"/>
                            <field name="total_p_input"/>
                            <field name="total_k_input"/>
                        </group>
                    </page>
                    <page string="Spatial Intelligence (GIS)" name="spatial_gis" invisible="not is_land_parcel">
                        <header>
                            <button name="action_calculate_area" string="Calculate Area from Boundary" type="object" class="btn-secondary" icon="fa-calculator"/>
                        </header>
                        <group>
                            <group string="Boundary Data">
                                <field name="boundary_geojson" widget="ace" options="{'mode': 'json'}" placeholder='{"type": "Polygon", "coordinates": [...]}'/>
                            </group>
                            <group string="Calculated Metrics">
                                <field name="calculated_area_ha"/>
                                <div class="alert alert-info" role="alert">
                                    <i class="fa fa-info-circle"/> Area is calculated using spherical Shoelace algorithm.
                                </div>
                            </group>
                        </group>
                    </page>
                </notebook>
                <group string="Boundary Data (GeoJSON)" invisible="not is_land_parcel">
                    <field name="gps_coordinates" nolabel="1" placeholder='{"type": "Polygon", "coordinates": [[...]]}'/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Map Action for Land Parcels -->
    <record id="action_farm_location_gis" model="ir.actions.act_window">
        <field name="name">Land Parcels (GIS)</field>
        <field name="res_model">stock.location</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('is_land_parcel', '=', True)]</field>
        <field name="context">{'default_is_land_parcel': True}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Define your first land parcel and its GIS coordinates.
            </p>
        </field>
    </record>

    <menuitem id="menu_farm_gis_root" name="GIS &amp; Mapping" parent="farm_core.menu_farm_root" sequence="50"/>
    <menuitem id="menu_farm_land_parcels" name="Land Parcels" parent="menu_farm_gis_root" action="action_farm_location_gis" sequence="10"/>
</odoo>
